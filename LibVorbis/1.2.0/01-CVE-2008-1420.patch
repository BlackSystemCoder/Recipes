--- ../old/libvorbis-1.2.0.dfsg/lib/misc.h	2007-07-24 00:09:47.000000000 +0000
+++ libvorbis-1.2.0.dfsg/lib/misc.h	2008-05-23 08:29:23.000000000 +0000
@@ -29,8 +29,9 @@
 #ifdef DEBUG_MALLOC
 
 #define _VDBG_GRAPHFILE "malloc.m"
-extern void *_VDBG_malloc(void *ptr,long bytes,char *file,long line); 
-extern void _VDBG_free(void *ptr,char *file,long line); 
+#undef _VDBG_GRAPHFILE
+void *_VDBG_malloc(void *ptr,long bytes,char *file,long line);
+void _VDBG_free(void *ptr,char *file,long line);
 
 #ifndef MISC_C 
 #undef _ogg_malloc
--- ../old/libvorbis-1.2.0.dfsg/lib/res0.c	2007-07-24 00:09:47.000000000 +0000
+++ libvorbis-1.2.0.dfsg/lib/res0.c	2008-05-23 08:22:57.000000000 +0000
@@ -223,6 +223,20 @@
   for(j=0;j<acc;j++)
     if(info->booklist[j]>=ci->books)goto errout;
 
+  /* verify the phrasebook is not specifying an impossible or
+     inconsistent partitioning scheme. */
+  {
+    int entries = ci->book_param[info->groupbook]->entries;
+    int dim = ci->book_param[info->groupbook]->dim;
+    int partvals = 1;
+    while(dim>0){
+      partvals *= info->partitions;
+      if(partvals > entries) goto errout;
+      dim--;
+    }
+    if(partvals != entries) goto errout;
+  }
+
   return(info);
  errout:
   res0_free_info(info);
@@ -263,7 +277,7 @@
     }
   }
 
-  look->partvals=rint(pow((float)look->parts,(float)dim));
+  look->partvals=look->phrasebook->entries;
   look->stages=maxstage;
   look->decodemap=_ogg_malloc(look->partvals*sizeof(*look->decodemap));
   for(j=0;j<look->partvals;j++){

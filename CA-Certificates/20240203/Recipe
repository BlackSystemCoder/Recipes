# Recipe for version 20240203 by Nuc1eoN, on Sat 09 Nov 2024 04:50:28 PM GMT
# Recipe (MakeRecipe) for CA-Certificates by Jean-Michel T.Dydak <jm.dev@gmx.com>, on Tue 01 Feb 2022 03:13:20 PM GMT
compile_version=017-GIT
urls=(
   "https://archive.mozilla.org/pub/security/nss/releases/NSS_3_106_RTM/src/nss-3.106.tar.gz"
   "https://debian.osuosl.org/debian/pool/main/c/ca-certificates/ca-certificates_20240203.tar.xz"
)

dir='nss-3.106'
unpack_files=inside_first

file_sizes=(
   76621626
   263276
)
file_md5s=(
   5beed92d43d33b03faf0ec5efd44d1b0
   228129ccf8cd99b991d771c44dd4052c
)

recipe_type=makefile

pre_build() {
   sed -i 's:/usr/share/ca-certificates:share/ca-certificates:' $sourcedir/ca-certificates/Makefile
   sed -i 's:/usr/sbin:/sbin:' $sourcedir/ca-certificates/sbin/Makefile
   sed -i \
   -e 's:/usr/share/ca-certificates:/usr/share/ca-certificates/mozilla:' \
   -e 's:/usr/local/share/ca-certificates:/usr/share/ca-certificates/mozilla:' \
   $sourcedir/ca-certificates/sbin/update-ca-certificates

   # Grab the database from the nss sources
   cp $sourcedir/nss/lib/ckfw/builtins/{certdata.txt,nssckbi.h} $sourcedir/ca-certificates/mozilla
}

make="ColorMake -C ca-certificates"

# Prevent potential install failure
# Putting this to pre_install() rather than do_install() will also flush /etc/ssl/certs/ (probably due to sandbox side-effects)
pre_install() {
   mkdir -p $target/share/ca-certificates
}

do_install() {
   # For some reasons make and ColorMake lead to different results.
   # ColorMake: /etc/ssl/certs/ will be completely emtpy
   # make: /etc/ssl/certs/ will be partially emptied
   # -> we probably want it flushed before running `update-ca-certificates`
   ColorMake -C ca-certificates install DESTDIR="$target"
}

pre_link() {
   mkdir -p $goboSettings/ca-certificates/update.d
   (
      echo "# Automatically generated by Compile."
      echo "# $(date -u)"
      echo "# Do not edit."
      find $target/share/ca-certificates/mozilla/* -printf "%f\n" -name '*.crt' | LC_ALL=C sort
   )  > $settings_target/ca-certificates.conf
}

post_install_message="\n\nIMPORTANT:\nYou must run as root 'sh ${goboSystem}/Index/bin/update-ca-certificates'.\n"
